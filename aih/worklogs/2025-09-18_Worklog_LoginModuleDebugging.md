# Worklog - IIIRegistrationPortal Migration - Login Module Debugging

**Date:** 2025-09-18

**Phase:** Phase 1 - Foundation Setup & Login Module Implementation

**Objective:** Resolve login functionality issues, specifically parameter population for ModelDriven actions and authentication.

---

## 1. Initial Parameter Population Issue (ModelDriven Failure)

**Problem:** The `userLoginId` and `password` properties of the `User` model in `LoginAction` were consistently `null` after form submission, despite form data being correctly sent. This indicated that Struts 2's `params` interceptor was failing to populate the `ModelDriven` object's properties.

**Debugging Steps & Attempts:**
*   **`struts.xml` DTD/Allowlist/Prefix:**
    *   Corrected `struts.xml` DTD from 2.5 to 2.6 (then reverted to 2.5 as 2.6 was incorrect).
    *   Corrected `struts.allowlist.packageNames` (`models` vs `model`, then back to `models` as per user's directory preference).
    *   Set `struts.mapper.action.prefix.enabled` to `false`.
*   **SQL Query Error:**
    *   Fixed `bad SQL grammar` by removing trailing spaces in SQL query in `UserQueries.java`.
*   **Interceptor Class Issues (`ClassNotFoundException`):**
    *   Created missing `SessionCheckInterceptor.java` and `LoginCheckInterceptor.java` files.
    *   Updated import statements in interceptors multiple times (from `com.opensymphony.xwork2` to `org.apache.struts2.xwork2`, then corrected again to `org.apache.struts2.ActionInvocation` and `org.apache.struts2.interceptor.Interceptor` based on Struts 7.0.0 package structure).
    *   Added definitions for `sessionCheck`, `loginCheck`, and `parameters` interceptors to `struts.xml` (with corrected class name for `parameters`).
*   **`SpringBeans.xml` Not Found:**
    *   Resolved by performing aggressive cleanup (deleting `target`, `webapps` content, Tomcat `work`/`temp`) and rebuild.
*   **Redirect Loops (`ERR_TOO_MANY_REDIRECTS`):**
    *   Corrected `login` and `sessionExpired` global results in `struts.xml` to redirect correctly.
    *   Separated `LoginAction_*` into explicit `LoginAction_input`, `LoginAction_authenticateUser`, and `LoginAction_logout` actions.
    *   Applied `publicStack` (without session check) to `LoginAction_input` and `genericDefaultStack` (with session check) to `LoginAction_authenticateUser` and `LoginAction_logout`.
*   **Core Parameter Population Debugging (ModelDriven):**
    *   **Diagnostic 1:** Temporarily removed `ModelDriven` and used direct properties in `LoginAction`. **Outcome:** Parameters still `null`, proving issue not specific to `ModelDriven`. (Change later reverted).
    *   **Diagnostic 2:** Temporarily removed `excludeParams` from `params` interceptor. **Outcome:** Parameters still `null`, ruling out `excludeParams`. (Change later reverted).
    *   **Diagnostic 3:** Temporarily disabled Spring integration for `LoginAction`. **Outcome:** Parameters still `null`, ruling out Spring integration as direct cause of `params` failure. (Change later reverted).
    *   **Diagnostic 4:** Added logger statements to `User` model setters. **Outcome:** Confirmed setters were *not* being called by `params` interceptor.

**Solution (for Parameter Population):**
Implemented manual parameter population using `ServletRequestAware`.
*   `LoginAction` now implements `ServletRequestAware`.
*   `LoginAction` has a `private HttpServletRequest request;` field.
*   `withServletRequest(HttpServletRequest request)` method (called by `servletConfig` interceptor) sets the `request` field.
*   Inside `authenticateUser()`, `user.setUserLoginId(request.getParameter("userLoginId"))` and `user.setPassword(request.getParameter("password"))` are used.
*   `servletConfig` interceptor added to `genericDefaultStack` in `struts.xml`.
*   Corrected `withServletRequest` method name (from `setServletRequest`).

**Outcome:** Parameters (`userLoginId`, `password`) are now correctly populated in the `User` model.

---

## 2. Password Mismatch Issue

**Problem:** "Invalid credentials" error after parameter population was fixed. Debugging showed the encrypted password generated by Java's `LoginEncryptor` did not match the encrypted password stored in the database.

**Debugging Steps & Attempts:**
*   Analyzed `dbo.fn_EncryptPassword.sql`, which revealed it calls `master.dbo.Encrypt` (a black box).
*   Examined `LoginEncryptor.java`'s initial implementation (using `PBKDF2WithHmacSHA1`).
*   User provided a new `LoginEncryptor.java` code snippet with a custom `deriveKey` method (mimicking C# `PasswordDeriveBytes` / PBKDF1) and a hardcoded derived key for testing.
*   Integrated the new `LoginEncryptor` code into the project.
*   Added debug log to `deriveKey` method to compare its output with the known correct hardcoded key. **Outcome:** `deriveKey` was producing a different key.

**Solution (Temporary for Password Mismatch):**
Temporarily reverted `encrypt` and `decrypt` methods in `LoginEncryptor.java` to use the hardcoded derived key provided by the user.

**Outcome:** Login successful with the hardcoded key. This confirmed the rest of the authentication flow was correct, and the issue was solely with the key derivation.

---

## 3. Current Issue: `NullPointerException` in `_TblUserLogin.varUserLoginID` during `logLogin`

**Problem:** After successful login (with hardcoded key), a `PSQLException` occurs: `null value in column "varUserLoginID" of relation "_TblUserLogin" violates not-null constraint`. This happens during the `userDao.logLogin()` call in `UserServiceImpl.authenticate()`.

**Analysis:**
*   The `INSERT_LOGIN_LOG` query in `UserQueries.java` expects `varUserLoginID` as a parameter.
*   `UserDaoImpl.logLogin()` is called with `user.getUserId()` and `user.getUserLoginId()`.
*   Contradiction: `user.getUserLoginId()` was confirmed to be populated (e.g., "TESTCOMPANY1") just before the `logLogin` call in previous logs, yet the database reports it as `null`.

**Current Debugging:**
*   Attempting to add a debug log *immediately before* the `logLogin` call in `UserServiceImpl.authenticate()` to confirm the value of `user.getUserLoginId()` at that exact moment. (This is where the last tool call was cancelled).

---

**Current Status:** Login form parameters are successfully populated into the `User` model. Authentication is successful when using a hardcoded encryption key. The application is now encountering a `NullPointerException` during the `logLogin` operation after successful authentication.

**Next Steps:**
1.  Re-attempt adding the debug log before `logLogin` call in `UserServiceImpl.authenticate()` to confirm `user.getUserLoginId()` value.
2.  Investigate why `varUserLoginID` is `null` in the database insert, despite `user.getUserLoginId()` appearing populated in logs.
3.  Once `logLogin` is fixed, revisit the dynamic key derivation in `LoginEncryptor.java` to replace the hardcoded key.
